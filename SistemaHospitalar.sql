-- ENDERECO
CREATE TABLE ENDERECO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  RUA VARCHAR2(200),
  NUMERO VARCHAR2(20),
  BAIRRO VARCHAR2(100),
  CIDADE VARCHAR2(100),
  ESTADO VARCHAR2(100),
  CEP VARCHAR2(20)
);

-- CONVENIO
CREATE TABLE CONVENIO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOME VARCHAR2(200) NOT NULL,
  VALOR NUMBER(15,2) NULL -- se aplicar
);

-- PACIENTE
CREATE TABLE PACIENTE (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOME VARCHAR2(200) NOT NULL,
  NOME_MAE VARCHAR2(200),
  SEXO CHAR(1) CHECK (SEXO IN ('M','F','O')) ,
  DATA_NASCIMENTO DATE,
  CPF VARCHAR2(14),
  ENDERECO_ID NUMBER,
  CONVENIO_ID NUMBER, -- convênio atual do paciente
  CONSTRAINT FK_PACIENTE_ENDERECO FOREIGN KEY (ENDERECO_ID) REFERENCES ENDERECO(ID),
  CONSTRAINT FK_PACIENTE_CONVENIO FOREIGN KEY (CONVENIO_ID) REFERENCES CONVENIO(ID)
);

-- SETOR
CREATE TABLE SETOR (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOME VARCHAR2(100) NOT NULL
);

-- PROFISSIONAL
CREATE TABLE PROFISSIONAL (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOME VARCHAR2(200) NOT NULL,
  TIPO_PROFISSIONAL VARCHAR2(100),
  CRM VARCHAR2(30),
  COREN VARCHAR2(30),
  ESPECIALIDADE VARCHAR2(100),
  SETOR_ID NUMBER,
  CONSTRAINT FK_PROFISSIONAL_SETOR FOREIGN KEY (SETOR_ID) REFERENCES SETOR(ID)
);

-- PROCEDIMENTO
CREATE TABLE PROCEDIMENTO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOME VARCHAR2(200) NOT NULL,
  DESCRICAO VARCHAR2(4000),
  VALOR NUMBER(15,2) -- valor padrão
);

-- LEITO
CREATE TABLE LEITO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NUMERO VARCHAR2(50),
  SETOR_ID NUMBER,
  CONSTRAINT FK_LEITO_SETOR FOREIGN KEY (SETOR_ID) REFERENCES SETOR(ID)
);

-- OCUPACAO_LEITO (LEITO_OCUPACAO)
CREATE TABLE OCUPACAO_LEITO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  LEITO_ID NUMBER NOT NULL,
  PACIENTE_ID NUMBER NOT NULL,
  DATA_OCUPACAO TIMESTAMP NOT NULL,
  DATA_ALTA TIMESTAMP NULL,
  CONSTRAINT FK_OCUPACAO_LEITO_LEITO FOREIGN KEY (LEITO_ID) REFERENCES LEITO(ID),
  CONSTRAINT FK_OCUPACAO_LEITO_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PACIENTE(ID)
);

-- AGENDAMENTO
CREATE TABLE AGENDAMENTO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  DATA_ATENDIMENTO TIMESTAMP NOT NULL,
  CONSULTORIO VARCHAR2(100),
  PRIORIDADE VARCHAR2(20), -- ou CHECK com valores esperados
  STATUS VARCHAR2(50),
  OBSERVACOES VARCHAR2(2000),
  PACIENTE_ID NUMBER,
  CONSTRAINT FK_AGENDAMENTO_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PACIENTE(ID)
);

-- ATENDIMENTO
CREATE TABLE ATENDIMENTO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_AGENDAMENTO NUMBER, -- ligação com agendamento se houver
  DATA_ATENDIMENTO TIMESTAMP,
  DIAGNOSTICO VARCHAR2(4000),
  OBSERVACOES VARCHAR2(4000),
  ID_PROFISSIONAL NUMBER,
  ID_LEITO NUMBER,
  STATUS_ATENDIMENTO VARCHAR2(100),
  PRIORIDADE_ATENDIMENTO VARCHAR2(20),
  PACIENTE_ID NUMBER,
  CONSTRAINT FK_ATENDIMENTO_AGENDAMENTO FOREIGN KEY (ID_AGENDAMENTO) REFERENCES AGENDAMENTO(ID),
  CONSTRAINT FK_ATENDIMENTO_PROFISSIONAL FOREIGN KEY (ID_PROFISSIONAL) REFERENCES PROFISSIONAL(ID),
  CONSTRAINT FK_ATENDIMENTO_LEITO FOREIGN KEY (ID_LEITO) REFERENCES LEITO(ID),
  CONSTRAINT FK_ATENDIMENTO_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PACIENTE(ID)
);

-- LABORATORIO
CREATE TABLE LABORATORIO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOME_LABORATORIO VARCHAR2(200)
);

-- PEDIDO_EXAME
CREATE TABLE PEDIDO_EXAME (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ATENDIMENTO_ID NUMBER NOT NULL,
  PEDIDO_EXAME_TX VARCHAR2(2000),
  DATA_EXAME DATE,
  RESULTADO VARCHAR2(4000),
  LABORATORIO_ID NUMBER,
  CONSTRAINT FK_PEDIDO_ATENDIMENTO FOREIGN KEY (ATENDIMENTO_ID) REFERENCES ATENDIMENTO(ID),
  CONSTRAINT FK_PEDIDO_LAB FOREIGN KEY (LABORATORIO_ID) REFERENCES LABORATORIO(ID)
);

-- FATURAMENTO
CREATE TABLE FATURAMENTO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  PACIENTE_ID NUMBER NOT NULL,
  CONVENIO_ID NUMBER NOT NULL, -- manter para histórico (snapshot)
  VALOR_COBRADO NUMBER(15,2) NOT NULL,
  FORMA_PAGAMENTO VARCHAR2(50),
  STATUS_PAGAMENTO VARCHAR2(50),
  DATA_EMISSAO DATE,
  DATA_PAGAMENTO DATE,
  CONSTRAINT FK_FAT_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PACIENTE(ID),
  CONSTRAINT FK_FAT_CONVENIO FOREIGN KEY (CONVENIO_ID) REFERENCES CONVENIO(ID)
);

-- AUDITORIA
CREATE TABLE AUDITORIA (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  TABELA_AFETADA VARCHAR2(200),
  REGISTRO_ID NUMBER,
  OPERACAO VARCHAR2(20),
  USUARIO VARCHAR2(100),
  DATA_HORA TIMESTAMP DEFAULT SYSTIMESTAMP,
  VALOR_ANTIGO CLOB,
  VALOR_NOVO CLOB
);

-- TABELA ASSOCIATIVA: (se necessário) CONVENIO <-> PROCEDIMENTO (N:N)
CREATE TABLE CONVENIO_PROCEDIMENTO (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  CONVENIO_ID NUMBER NOT NULL,
  PROCEDIMENTO_ID NUMBER NOT NULL,
  VALOR_CONVENIO NUMBER(15,2),
  CONSTRAINT FK_CP_CONVENIO FOREIGN KEY (CONVENIO_ID) REFERENCES CONVENIO(ID),
  CONSTRAINT FK_CP_PROCEDIMENTO FOREIGN KEY (PROCEDIMENTO_ID) REFERENCES PROCEDIMENTO(ID),
  CONSTRAINT UQ_CONV_PROC UNIQUE (CONVENIO_ID, PROCEDIMENTO_ID)
);

ALTER TABLE ATENDIMENTO
  ADD NIVEL_URGENCIA NUMBER(1)
    CHECK (NIVEL_URGENCIA BETWEEN 1 AND 5);

CREATE TABLE ATENDIMENTO_EMERGENCIAL (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_ATENDIMENTO NUMBER NOT NULL,
  NIVEL_URGENCIA NUMBER(1) CHECK (NIVEL_URGENCIA BETWEEN 1 AND 5),
  DESCRICAO_INICIAL VARCHAR2(4000),
  DATA_REGISTRO TIMESTAMP DEFAULT SYSTIMESTAMP,

  CONSTRAINT FK_EMERGENCIA_ATENDIMENTO 
    FOREIGN KEY (ID_ATENDIMENTO) 
    REFERENCES ATENDIMENTO(ID)
);
SELECT ID, NOME FROM PACIENTE ORDER BY ID;


--  INSERTS
-- CONVÊNIOS
INSERT INTO CONVENIO (NOME, VALOR) VALUES
('Saúde Total', 200.00),
('Medicare', 150.00),
('Unimed', 180.00),
('Bradesco Saúde', 250.00),
('Amil', 220.00);

-- ENDEREÇOS
INSERT INTO ENDERECO (RUA, NUMERO, BAIRRO, CIDADE, ESTADO, CEP) VALUES
('Rua das Flores', '123', 'Centro', 'São Paulo', 'SP', '01001-000'),
('Avenida Brasil', '456', 'Jardins', 'São Paulo', 'SP', '01401-000'),
('Rua das Laranjeiras', '78', 'Copacabana', 'Rio de Janeiro', 'RJ', '22040-002'),
('Rua do Sol', '200', 'Ipanema', 'Rio de Janeiro', 'RJ', '22420-001'),
('Rua da Paz', '150', 'Centro', 'Belo Horizonte', 'MG', '30130-000'),
('Avenida Atlântica', '300', 'Praia', 'Salvador', 'BA', '40020-000'),
('Rua das Acácias', '55', 'Boa Vista', 'Fortaleza', 'CE', '60040-000'),
('Rua da Harmonia', '89', 'Moema', 'São Paulo', 'SP', '04501-001'),
('Rua Nova', '22', 'Centro', 'Porto Alegre', 'RS', '90010-000'),
('Avenida Central', '101', 'Centro', 'Curitiba', 'PR', '80010-000'),
('Rua do Comércio', '400', 'Centro', 'Manaus', 'AM', '69010-001'),
('Rua do Limoeiro', '88', 'Centro', 'Recife', 'PE', '50010-001'),
('Rua Esperança', '77', 'Centro', 'Florianópolis', 'SC', '88010-001'),
('Rua Primavera', '25', 'Centro', 'Campinas', 'SP', '13010-000'),
('Rua do Carmo', '90', 'Centro', 'Natal', 'RN', '59010-000'),
('Rua da Liberdade', '35', 'Centro', 'Goiânia', 'GO', '74010-000'),
('Rua Vitória', '12', 'Centro', 'Vitória', 'ES', '29010-000'),
('Rua Santa Maria', '180', 'Centro', 'São Luís', 'MA', '65010-000'),
('Rua das Palmeiras', '77', 'Centro', 'João Pessoa', 'PB', '58010-000'),
('Rua das Orquídeas', '66', 'Centro', 'Maceió', 'AL', '57010-000');



-- PACIENTES
INSERT INTO PACIENTE (NOME, NOME_MAE, SEXO, DATA_NASCIMENTO, CPF, ENDERECO_ID, CONVENIO_ID) VALUES
('Carlos Silva', 'Maria Silva', 'M', TO_DATE('1985-03-15','YYYY-MM-DD'), '123.456.789-01', 1, 1),
('Ana Souza', 'Clara Souza', 'F', TO_DATE('1990-07-22','YYYY-MM-DD'), '987.654.321-00', 2, 2),
('João Pereira', 'Lucia Pereira', 'M', TO_DATE('1975-12-05','YYYY-MM-DD'), '111.222.333-44', 3, 3),
('Mariana Lima', 'Fernanda Lima', 'F', TO_DATE('2000-01-10','YYYY-MM-DD'), '555.666.777-88', 4, 4),
('Pedro Alves', 'Rita Alves', 'M', TO_DATE('1995-09-30','YYYY-MM-DD'), '999.888.777-66', 5, 5),
('Carla Mendes', 'Sonia Mendes', 'F', TO_DATE('1988-06-12','YYYY-MM-DD'), '222.333.444-55', 6, 1),
('Lucas Rocha', 'Patricia Rocha', 'M', TO_DATE('2001-04-18','YYYY-MM-DD'), '333.444.555-66', 7, 2),
('Juliana Castro', 'Adriana Castro', 'F', TO_DATE('1992-11-08','YYYY-MM-DD'), '444.555.666-77', 8, 3),
('Ricardo Martins', 'Elaine Martins', 'M', TO_DATE('1980-05-25','YYYY-MM-DD'), '555.666.777-88', 9, 4),
('Bianca Fernandes', 'Rosa Fernandes', 'F', TO_DATE('1999-08-19','YYYY-MM-DD'), '666.777.888-99', 10, 5),
('Thiago Santos', 'Claudia Santos', 'M', TO_DATE('1987-02-02','YYYY-MM-DD'), '777.888.999-00', 11, 1),
('Patrícia Oliveira', 'Sandra Oliveira', 'F', TO_DATE('1993-03-03','YYYY-MM-DD'), '888.999.000-11', 12, 2),
('Gabriel Nunes', 'Regina Nunes', 'M', TO_DATE('1979-12-12','YYYY-MM-DD'), '999.000.111-22', 13, 3),
('Camila Ribeiro', 'Luciana Ribeiro', 'F', TO_DATE('1996-10-10','YYYY-MM-DD'), '111.222.333-44', 14, 4),
('Felipe Costa', 'Patrícia Costa', 'M', TO_DATE('1983-05-05','YYYY-MM-DD'), '222.333.444-55', 15, 5),
('Larissa Teixeira', 'Carla Teixeira', 'F', TO_DATE('1991-01-15','YYYY-MM-DD'), '333.444.555-66', 16, 1),
('Rafael Almeida', 'Vanessa Almeida', 'M', TO_DATE('1989-09-09','YYYY-MM-DD'), '444.555.666-77', 17, 2),
('Natália Azevedo', 'Renata Azevedo', 'F', TO_DATE('2002-02-22','YYYY-MM-DD'), '555.666.777-88', 18, 3),
('Vinícius Lopes', 'Sofia Lopes', 'M', TO_DATE('1997-07-07','YYYY-MM-DD'), '666.777.888-99', 19, 4),
('Bruna Carvalho', 'Daniela Carvalho', 'F', TO_DATE('1994-04-04','YYYY-MM-DD'), '777.888.999-00', 20, 5);

-- SETORES
INSERT INTO SETOR (NOME) VALUES
('Cardiologia'),
('Pediatria'),
('Ortopedia'),
('Clínica Geral'),
('Emergência');



-- PROFISSIONAIS
INSERT INTO PROFISSIONAL (NOME, TIPO_PROFISSIONAL, CRM, COREN, ESPECIALIDADE, SETOR_ID) VALUES
('Dr. Paulo Silva', 'Médico', '12345-SP', NULL, 'Cardiologia', 1),
('Dra. Fernanda Souza', 'Médico', '54321-SP', NULL, 'Pediatria', 2),
('Dr. Ricardo Alves', 'Médico', '67890-RJ', NULL, 'Ortopedia', 3),
('Dra. Camila Rocha', 'Médico', '09876-RJ', NULL, 'Clínica Geral', 4),
('Enf. Ana Pereira', 'Enfermeiro', NULL, 'COREN-1234', 'Emergência', 5),
('Dr. Lucas Mendes', 'Médico', '11223-SP', NULL, 'Cardiologia', 1),
('Dra. Bianca Martins', 'Médico', '44556-SP', NULL, 'Pediatria', 2),
('Enf. João Costa', 'Enfermeiro', NULL, 'COREN-5678', 'Ortopedia', 3),
('Dr. Felipe Carvalho', 'Médico', '77889-MG', NULL, 'Clínica Geral', 4),
('Dra. Larissa Teixeira', 'Médico', '33445-MG', NULL, 'Emergência', 5);

-- AGENDAMENTOS
INSERT INTO AGENDAMENTO (DATA_ATENDIMENTO, CONSULTORIO, PRIORIDADE, STATUS, OBSERVACOES, PACIENTE_ID) VALUES
(SYSTIMESTAMP,'101','Alta','Agendado','Paciente com dor no peito',41),
(SYSTIMESTAMP,'102','Média','Agendado','Consulta de rotina',42),
(SYSTIMESTAMP,'201','Baixa','Agendado','Fratura no braço',43),
(SYSTIMESTAMP,'202','Alta','Agendado','Febre alta',44),
(SYSTIMESTAMP,'301','Média','Agendado','Dores nas costas',45),
(SYSTIMESTAMP,'302','Alta','Agendado','Sintomas respiratórios',46),
(SYSTIMESTAMP,'401','Baixa','Agendado','Consulta de acompanhamento',47),
(SYSTIMESTAMP,'402','Média','Agendado','Consulta pediátrica',48),
(SYSTIMESTAMP,'501','Alta','Agendado','Acidente doméstico',49),
(SYSTIMESTAMP,'502','Média','Agendado','Exame de rotina',50);

-- LEITOS
INSERT INTO LEITO (NUMERO, SETOR_ID) VALUES
('101',1),('102',1),('201',2),('202',2),('301',3),
('302',3),('401',4),('402',4),('501',5),('502',5);

SELECT * FROM AGENDAMENTO;

INSERT INTO ATENDIMENTO (ID_AGENDAMENTO, DATA_ATENDIMENTO, DIAGNOSTICO, OBSERVACOES, ID_PROFISSIONAL, ID_LEITO, STATUS_ATENDIMENTO, PRIORIDADE_ATENDIMENTO, PACIENTE_ID) VALUES
(41,SYSTIMESTAMP,'Infarto Agudo','Paciente chegou com dor torácica',21,1,'Concluído','Alta',41),
(42,SYSTIMESTAMP,'Hipertensão','Consulta de rotina',22,2,'Concluído','Média',42),
(43,SYSTIMESTAMP,'Fratura do rádio','Atendimento emergencial',23,3,'Concluído','Alta',43),
(44,SYSTIMESTAMP,'Gripe','Febre e tosse',24,4,'Concluído','Alta',44),
(45,SYSTIMESTAMP,'Hérnia de disco','Dores nas costas',25,5,'Concluído','Média',45),
(46,SYSTIMESTAMP,'Pneumonia','Sintomas respiratórios graves',26,6,'Concluído','Alta',46),
(47,SYSTIMESTAMP,'Revisão pós-cirurgia','Consulta de acompanhamento',27,7,'Concluído','Baixa',47),
(48,SYSTIMESTAMP,'Varicela','Paciente pediátrico',28,8,'Concluído','Média',48),
(49,SYSTIMESTAMP,'Corte profundo','Acidente doméstico',29,9,'Concluído','Alta',49),
(50,SYSTIMESTAMP,'Check-up','Exame de rotina',30,10,'Concluído','Média',50);



-- Listar todos os atendimentos com dados do paciente, profissional, setor e leito
SELECT 
    a.ID AS ID_ATENDIMENTO,
    p.NOME AS PACIENTE,
    pr.NOME AS PROFISSIONAL,
    s.NOME AS SETOR,
    l.NUMERO AS LEITO,
    a.DIAGNOSTICO,
    a.DATA_ATENDIMENTO,
    a.PRIORIDADE_ATENDIMENTO
FROM ATENDIMENTO a
JOIN PACIENTE p ON p.ID = a.PACIENTE_ID
JOIN PROFISSIONAL pr ON pr.ID = a.ID_PROFISSIONAL
JOIN SETOR s ON s.ID = pr.SETOR_ID
LEFT JOIN LEITO l ON l.ID = a.ID_LEITO
ORDER BY a.DATA_ATENDIMENTO DESC;


-- 2) Listar total de atendimentos por setor com filtro HAVING
SELECT 
    s.NOME AS SETOR,
    COUNT(*) AS TOTAL_ATENDIMENTOS
FROM ATENDIMENTO a
JOIN PROFISSIONAL pr ON pr.ID = a.ID_PROFISSIONAL
JOIN SETOR s ON s.ID = pr.SETOR_ID
GROUP BY s.NOME
HAVING COUNT(*) > 2
ORDER BY TOTAL_ATENDIMENTOS DESC;


-- 3) Encontrar os pacientes que têm mais de 1 atendimento

SELECT 
    p.NOME,
    COUNT(*) AS QTDE_ATENDIMENTOS
FROM ATENDIMENTO a
JOIN PACIENTE p ON p.ID = a.PACIENTE_ID
GROUP BY p.NOME
HAVING COUNT(*) > 1;


-- 4) Consultar os pacientes que nunca fizeram agendamento

SELECT 
    p.ID,
    p.NOME
FROM PACIENTE p
WHERE NOT EXISTS (
    SELECT 1 
    FROM AGENDAMENTO ag
    WHERE ag.PACIENTE_ID = p.ID
);

-- 5) Valor total faturado por convênio

SELECT
    c.NOME AS CONVENIO,
    SUM(f.VALOR_COBRADO) AS TOTAL_FATURADO
FROM FATURAMENTO f
JOIN CONVENIO c ON c.ID = f.CONVENIO_ID
GROUP BY c.NOME
ORDER BY TOTAL_FATURADO DESC;

-- 6) Listar o atendimento mais recente para cada paciente

SELECT *
FROM (
    SELECT
        a.ID,
        a.PACIENTE_ID,
        p.NOME AS PACIENTE,
        a.DATA_ATENDIMENTO,
        a.DIAGNOSTICO,
        ROW_NUMBER() OVER (PARTITION BY a.PACIENTE_ID ORDER BY a.DATA_ATENDIMENTO DESC) AS RN
    FROM ATENDIMENTO a
    JOIN PACIENTE p ON p.ID = a.PACIENTE_ID
)
WHERE RN = 1;

-- 7) Quantidade de agendamentos por prioridade, apenas prioridades “Alta” e “Média”

SELECT 
    PRIORIDADE,
    COUNT(*) AS QTDE
FROM AGENDAMENTO
GROUP BY PRIORIDADE
HAVING PRIORIDADE IN ('Alta', 'Média');

-- 8) Exibir pacientes que possuem convênio da Amil ou Unimed e tiveram atendimento nos últimos 30 dias

SELECT 
    p.NOME,
    c.NOME AS CONVENIO,
    a.DATA_ATENDIMENTO
FROM PACIENTE p
JOIN CONVENIO c ON c.ID = p.CONVENIO_ID
JOIN ATENDIMENTO a ON a.PACIENTE_ID = p.ID
WHERE c.NOME IN ('Amil', 'Unimed')
  AND a.DATA_ATENDIMENTO >= SYSDATE - 30
ORDER BY a.DATA_ATENDIMENTO DESC;


-- 9) Tempo médio entre agendamento e atendimento
SELECT 
    AVG(a.DATA_ATENDIMENTO - ag.DATA_ATENDIMENTO) * 24 AS MEDIA_HORAS
FROM ATENDIMENTO a
JOIN AGENDAMENTO ag ON ag.ID = a.ID_AGENDAMENTO;

-- 10) Listar o setor mais movimentado (com mais atendimentos)

SELECT *
FROM (
    SELECT 
        s.NOME AS SETOR,
        COUNT(*) AS QTDE
    FROM ATENDIMENTO a
    JOIN PROFISSIONAL pr ON pr.ID = a.ID_PROFISSIONAL
    JOIN SETOR s ON s.ID = pr.SETOR_ID
    GROUP BY s.NOME
    ORDER BY QTDE DESC
)
WHERE ROWNUM = 1;




